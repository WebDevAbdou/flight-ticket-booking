<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Page</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .test { margin: 10px 0; padding: 10px; background: white; border-left: 4px solid #ccc; }
        .pass { border-left-color: green; }
        .fail { border-left-color: red; }
        .info { border-left-color: blue; }
        pre { background: #f0f0f0; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Flight Booking System Diagnostics</h1>
    <div id="results"></div>

    <script>
        const results = document.getElementById('results');
        
        function addResult(title, status, message, data = null) {
            const div = document.createElement('div');
            div.className = `test ${status}`;
            div.innerHTML = `
                <h3>${status === 'pass' ? '‚úÖ' : status === 'fail' ? '‚ùå' : '‚ÑπÔ∏è'} ${title}</h3>
                <p>${message}</p>
                ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
            `;
            results.appendChild(div);
        }

        async function runDiagnostics() {
            // Test 1: Check if home.js is loaded
            addResult('Test 1', 'info', 'Checking if home.js loads...');
            
            try {
                const response = await fetch('/js/home.js');
                const text = await response.text();
                if (text.includes('home.js loaded successfully')) {
                    addResult('home.js File', 'pass', 'home.js file exists and contains expected code', {
                        size: text.length + ' characters',
                        firstLine: text.split('\n')[0]
                    });
                } else {
                    addResult('home.js File', 'fail', 'home.js exists but content is unexpected');
                }
            } catch (error) {
                addResult('home.js File', 'fail', 'Failed to load home.js: ' + error.message);
            }

            // Test 2: Check API health
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                addResult('API Health', 'pass', 'API is responding', data);
            } catch (error) {
                addResult('API Health', 'fail', 'API health check failed: ' + error.message);
            }

            // Test 3: Check flights API
            try {
                const response = await fetch('/api/flights');
                const data = await response.json();
                if (data.success && data.flights && data.flights.length > 0) {
                    addResult('Flights API', 'pass', `API returned ${data.count} flights`, {
                        count: data.count,
                        firstFlight: data.flights[0]
                    });
                } else {
                    addResult('Flights API', 'fail', 'API returned no flights', data);
                }
            } catch (error) {
                addResult('Flights API', 'fail', 'Flights API failed: ' + error.message);
            }

            // Test 4: Check origins API
            try {
                const response = await fetch('/api/flights/origins');
                const data = await response.json();
                addResult('Origins API', data.success ? 'pass' : 'fail', 
                    `Origins API returned ${data.origins?.length || 0} origins`, data);
            } catch (error) {
                addResult('Origins API', 'fail', 'Origins API failed: ' + error.message);
            }

            // Test 5: Check if DOM elements exist on index.html
            addResult('Test 5', 'info', 'Checking index.html structure...');
            
            try {
                const response = await fetch('/');
                const html = await response.text();
                
                const checks = {
                    'flightsList div': html.includes('id="flightsList"'),
                    'loadingSpinner div': html.includes('id="loadingSpinner"'),
                    'noFlights div': html.includes('id="noFlights"'),
                    'auth.js script': html.includes('src="/js/auth.js"'),
                    'home.js script': html.includes('src="/js/home.js"')
                };
                
                const allPass = Object.values(checks).every(v => v);
                addResult('HTML Structure', allPass ? 'pass' : 'fail', 
                    'Checking required elements in index.html', checks);
            } catch (error) {
                addResult('HTML Structure', 'fail', 'Failed to check HTML: ' + error.message);
            }

            // Test 6: Check browser console for errors
            addResult('Browser Console', 'info', 
                'Open browser DevTools (F12) and check Console tab for JavaScript errors');

            // Test 7: Simulate what home.js does
            addResult('Test 7', 'info', 'Simulating home.js behavior...');
            
            setTimeout(async () => {
                try {
                    const response = await fetch('http://localhost:3000/api/flights');
                    const data = await response.json();
                    
                    if (data.success && data.flights && data.flights.length > 0) {
                        addResult('Simulated Flight Load', 'pass', 
                            `Successfully fetched ${data.count} flights using same method as home.js`, {
                                url: 'http://localhost:3000/api/flights',
                                method: 'GET',
                                flightCount: data.count
                            });
                    } else {
                        addResult('Simulated Flight Load', 'fail', 'No flights returned', data);
                    }
                } catch (error) {
                    addResult('Simulated Flight Load', 'fail', 'Error: ' + error.message);
                }
            }, 1000);
        }

        // Run diagnostics on page load
        runDiagnostics();
    </script>
</body>
</html>

